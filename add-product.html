<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EINHEIT | Add Gear Collective</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #000; --surf: #0d0d0d; --bord: #222; --dim: #999; 
            --accent: #00ff88; --max-w-desktop: 1100px; 
        }
        
        * { box-sizing: border-box; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; margin: 0; padding: 0; overflow-x: hidden; width: 100%; }

        /* GLOBAL LOADER */
        #global-loader {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px);
            z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { 
            width: 40px; height: 40px; 
            border: 3px solid rgba(255,255,255,0.1); 
            border-top-color: var(--accent); 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
            margin: 0 auto 20px; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .load-text { 
            color: var(--accent); 
            font-size: 10px; 
            font-weight: 700; 
            letter-spacing: 2px; 
            text-transform: uppercase; 
            font-family: 'Inter', sans-serif;
        }

        /* NAVIGATION */
        nav { display: flex; justify-content: center; align-items: center; position: fixed; width: 100%; top: 20px; z-index: 9999; padding: 0 15px; }
        .nav-container { 
            width: 100%; max-width: var(--max-w-desktop); display: flex; justify-content: space-between; align-items: center; 
            padding: 0 25px; background: rgba(15, 15, 15, 0.8); backdrop-filter: blur(20px); border: 1px solid var(--bord); border-radius: 100px; height: 75px; 
        }
        .nav-logo-img { height: 55px; width: auto; }

        /* MAIN WRAPPER */
        .wrapper { width: 100%; max-width: 600px; margin: 0 auto; padding: 150px 20px 80px; min-height: 100vh; }
        
        .stagger > * { opacity: 0; transform: translateY(25px); animation: fadeUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }

        h2 { font-size: 32px; font-weight: 800; letter-spacing: -1.5px; margin-bottom: 10px; text-align: center; text-transform: uppercase; }
        .sub-head { color: var(--dim); font-size: 13px; text-align: center; margin-bottom: 50px; text-transform: uppercase; letter-spacing: 2px; line-height: 1.6; }

        /* DYNAMIC GREETING */
        #personal-greet { 
            background: #111; border: 1px solid var(--bord); padding: 18px 25px; border-radius: 100px;
            color: white; font-size: 11px; font-weight: 800; text-align: center; 
            margin-bottom: 35px; text-transform: uppercase; letter-spacing: 1.5px; display: none;
        }

        /* SECTIONS */
        section { margin-bottom: 45px; border-top: 1px solid var(--bord); padding-top: 35px; }
        section h3 { font-size: 11px; text-transform: uppercase; color: white; letter-spacing: 2.5px; margin-bottom: 30px; font-weight: 800; }

        .form-group { margin-bottom: 25px; }
        label { display: block; font-size: 11px; color: var(--dim); margin-bottom: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        
        input {
            width: 100%; background: var(--surf); border: 1px solid var(--bord); 
            border-radius: 14px; padding: 18px; color: white; font-family: 'Inter', sans-serif; font-size: 14px; outline: none;
        }
        input:focus { border-color: #666; background: #111; box-shadow: 0 0 0 4px rgba(255,255,255,0.03); }

        /* LIVE PREVIEW CARD */
        .preview-box {
            background: var(--surf); border: 1px solid var(--bord); border-radius: 28px;
            overflow: hidden; max-width: 300px; margin: 0 auto 35px; box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        .img-prev { width: 100%; aspect-ratio: 1/1; background: #080808; display: flex; align-items: center; justify-content: center; position: relative; }
        .img-prev img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .info-prev { padding: 30px; text-align: center; border-top: 1px solid var(--bord); }
        .info-prev h4 { margin: 0; font-size: 15px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 800; }
        .info-prev p { margin: 10px 0 0; font-size: 10px; color: var(--dim); font-family: 'JetBrains Mono'; letter-spacing: 1px; }

        /* BUTTON & ERROR */
        #error-msg { color: #ff4444; font-size: 10px; font-weight: 800; margin-top: 15px; text-align: center; display: none; text-transform: uppercase; letter-spacing: 1.5px; }
        .btn-apply {
            width: 100%; background: white; color: black; padding: 22px; border: none; border-radius: 100px;
            font-weight: 800; text-transform: uppercase; letter-spacing: 3px; cursor: pointer; font-size: 12px;
        }
        .btn-apply:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255,255,255,0.1); }

        /* SUCCESS STATE */
        #state-success { 
            display: none; text-align: center; flex-direction: column; 
            align-items: center; justify-content: center; min-height: 55vh; 
        }
        .check-icon {
            width: 90px; height: 90px; background: var(--accent); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin-bottom: 35px;
            box-shadow: 0 15px 35px rgba(0, 255, 136, 0.25);
        }
        .check-icon svg { width: 45px; height: 45px; stroke: black; stroke-width: 4px; display: block; }

        #state-form { display: none; }

        /* ANIMATIONS */
        @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes blurOut { from { opacity: 1; filter: blur(0); } to { opacity: 0; filter: blur(15px); transform: translateY(-30px); } }
        @keyframes blurIn { from { opacity: 0; filter: blur(15px); } to { opacity: 1; filter: blur(0); } }
    </style>
</head>
<body>

    <div id="global-loader">
        <div class="spinner"></div>
        <div class="load-text" id="load-status">SCANNING DATA...</div>
    </div>

    <nav>
        <div class="nav-container">
            <a href="index.html"><img src="https://files.catbox.moe/iru1fz.png" class="nav-logo-img"></a>
            <a href="gallery.html" style="color: var(--dim); text-decoration: none; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px;">Back</a>
        </div>
    </nav>

    <div class="wrapper">
        
        <div id="state-login" class="stagger">
            <h2>VERIFY ACCESS.</h2>
            <p class="sub-head">Input member identification to unlock collective asset registry.</p>
            <section style="border:none">
                <div class="form-group">
                    <label>Member Serial ID</label>
                    <input type="text" id="memberID" placeholder="EHT-XXXXX" oninput="document.getElementById('error-msg').style.display='none'">
                    <p id="error-msg">ID Not Found :(</p>
                </div>
                <button class="btn-apply" onclick="handleLogin()">Authorize Access</button>
            </section>
        </div>

        <div id="state-form">
            <h2>ADD ASSET.</h2>
            <p id="personal-greet"></p>
            <p class="sub-head">Collective hardware and software synchronization module.</p>

            <form id="productForm">
                <section>
                    <h3>Identification</h3>
                    <div class="form-group">
                        <label>Asset Model Name</label>
                        <input type="text" id="pName" placeholder="e.g. Xperia 1 V" required oninput="syncPreview()">
                    </div>
                    <div class="form-group">
                        <label>Serial ID</label>
                        <input type="text" id="pSerial" placeholder="e.g. EH-01" required oninput="syncPreview()">
                    </div>
                </section>

                <section>
                    <h3>Resource Link</h3>
                    <div class="form-group">
                        <label>Image URL (Direct Link)</label>
                        <input type="url" id="pImg" placeholder="https://files.catbox.moe/..." required oninput="syncPreview()">
                    </div>
                </section>

                <section>
                    <h3>Registry Preview</h3>
                    <div class="preview-box">
                        <div class="img-prev" id="previewContainer">
                            <span id="noDataTxt" style="font-size:9px; color:#333; font-family:'JetBrains Mono'; font-weight:800; letter-spacing:2px;">NO RESOURCE DATA</span>
                            <img src="" id="imgPrev">
                        </div>
                        <div class="info-prev">
                            <h4 id="namePrev">PRODUCT NAME</h4>
                            <p id="serialPrev">SERIAL: EH-XXXX</p>
                        </div>
                    </div>

                    <button type="submit" class="btn-apply" id="submitBtn">Publish Your Product</button>
                </section>
            </form>
        </div>

        <div id="state-success">
            <div class="check-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <h2>DEPLOYED.</h2>
            <p style="color:var(--dim); font-size:14px; margin-bottom:45px; max-width: 420px; line-height: 1.7;">
                Synchronization successful. Your asset has been written to the collective database and is now pending public registry update.
            </p>
            <a href="gallery.html" style="color:white; text-decoration:none; border:1px solid var(--bord); padding:20px 50px; border-radius:100px; font-weight:800; font-size:11px; text-transform:uppercase; letter-spacing:2px;">
                View Gallery
            </a>
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwTRkyxhOiGqEL2hMzd4ncg9pgtcx3zqQalLKuRF2Cu_fzUGz3Duf7aV4qLh9eoYQvN/exec';
        
        const loader = document.getElementById('global-loader');
        const loadStatus = document.getElementById('load-status');

        function toggleLoader(show, text = "SCANNING DATA...") {
            loadStatus.innerText = text;
            loader.style.display = show ? 'flex' : 'none';
        }

        async function handleLogin() {
            const idInput = document.getElementById('memberID').value.trim();
            const err = document.getElementById('error-msg');
            if (!idInput) return;

            toggleLoader(true, "VERIFYING MEMBER ID...");
            
            try {
                const response = await fetch(`${scriptURL}?action=verify&id=${encodeURIComponent(idInput)}`);
                const result = await response.json();
                toggleLoader(false);

                if (result.success) {
                    document.getElementById('personal-greet').innerText = `Hai ${result.data.owner}, proceed with asset registration.`;
                    document.getElementById('personal-greet').style.display = 'block';
                    transition('state-login', 'state-form');
                } else {
                    err.style.display = 'block';
                    err.innerText = "Member ID Not Found!";
                }
            } catch (e) {
                toggleLoader(false);
                alert("Connection Error. Please check your internet.");
            }
        }

        function syncPreview() {
            document.getElementById('namePrev').innerText = document.getElementById('pName').value || "PRODUCT NAME";
            document.getElementById('serialPrev').innerText = "SERIAL: " + (document.getElementById('pSerial').value || "EH-XXXX");
            const url = document.getElementById('pImg').value;
            const img = document.getElementById('imgPrev');
            const txt = document.getElementById('noDataTxt');
            
            if (url && url.includes('http')) {
                img.src = url; 
                img.onload = () => { img.style.display = 'block'; txt.style.display = 'none'; };
                img.onerror = () => { img.style.display = 'none'; txt.style.display = 'block'; };
            } else {
                img.style.display = 'none'; txt.style.display = 'block';
            }
        }

        function transition(from, to) {
            const f = document.getElementById(from);
            const t = document.getElementById(to);
            f.style.animation = 'blurOut 0.6s ease-in forwards';
            setTimeout(() => {
                f.style.display = 'none';
                t.style.display = (to === 'state-success') ? 'flex' : 'block';
                t.style.animation = 'blurIn 0.8s ease-out forwards';
            }, 600);
        }

        // --- BAGIAN YANG DIPERBAIKI ---
        document.getElementById('productForm').onsubmit = async (e) => {
            e.preventDefault();
            toggleLoader(true, "DEPLOYING ASSET...");

            // Kirim menggunakan format Form URL Encoded agar lebih stabil dengan no-cors
            const formData = new URLSearchParams();
            formData.append('action', 'submitGallery'); // HARUS SAMA DENGAN APPS SCRIPT
            formData.append('brand', document.getElementById('pName').value);
            formData.append('product', document.getElementById('pSerial').value);
            formData.append('image', document.getElementById('pImg').value);

            try {
                await fetch(scriptURL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString()
                });

                // Beri sedikit jeda waktu sebelum transisi sukses
                setTimeout(() => {
                    toggleLoader(false);
                    transition('state-form', 'state-success');
                }, 1500);
                
            } catch (err) {
                toggleLoader(false);
                alert("Fatal Error: Could not reach database.");
            }
        };
    </script>
</body>
</html>
